{% extends "inventario/base.html" %}

{% block title %}Gestionar Inventario{% endblock %}

{% block content %}
<style>
    /* Estilo para el contenedor de la tabla con scroll */
    .scrollable-table-container {
        max-height: 600px; /* Ajusta esta altura según tu preferencia */
        overflow-y: auto;
    }
</style>

<div class="row g-4">
    <div class="col-lg-4">
        <div class="card shadow-sm border-0">
            <div class="card-header bg-light">
                <h4 class="mb-0">Añadir Nuevo Producto/Servicio</h4>
            </div>
            <div class="card-body">
                <form method="post" novalidate>
                    {% csrf_token %}

                    <div class="mb-3">
                        <label for="{{ form.nombre.id_for_label }}" class="form-label">{{ form.nombre.label }}</label>
                        {{ form.nombre }}
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.precio.id_for_label }}" class="form-label">{{ form.precio.label }}</label>
                        {{ form.precio }}
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.unidad_medida.id_for_label }}" class="form-label">{{ form.unidad_medida.label }}</label>
                        {{ form.unidad_medida }}
                    </div>

                    <div class="form-check form-switch p-3 mb-3 d-flex justify-content-between align-items-center">
                        <label class="form-check-label" for="{{ form.requiere_stock.id_for_label }}">
                            {{ form.requiere_stock.label }}
                        </label>
                        {{ form.requiere_stock }}
                    </div>
                    
                    <div id="stock-field-wrapper">
                        <div class="mb-3">
                            <label for="{{ form.stock.id_for_label }}" class="form-label">{{ form.stock.label }}</label>
                            {{ form.stock }}
                        </div>
                    </div>

                    <div class="form-check form-switch p-3 mb-3 d-flex justify-content-between align-items-center">
                        <label class="form-check-label" for="mayoreoSwitch">
                            Agregar precio de mayoreo
                        </label>
                        <input class="form-check-input" type="checkbox" role="switch" id="mayoreoSwitch">
                    </div>

                    <div id="mayoreo-fields-wrapper">
                        <div class="mb-3">
                            <label for="{{ form.precio_mayoreo.id_for_label }}" class="form-label">{{ form.precio_mayoreo.label }}</label>
                            {{ form.precio_mayoreo }}
                        </div>
                         <div class="mb-3">
                            <label for="{{ form.mayoreo_desde_kg.id_for_label }}" class="form-label">{{ form.mayoreo_desde_kg.label }}</label>
                            {{ form.mayoreo_desde_kg }}
                        </div>
                    </div>

                    <div class="d-grid mt-4">
                        <button type="submit" class="btn btn-primary btn-lg">Guardar Producto</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-8">
        <div class="card shadow-sm border-0">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h4 class="mb-0">Mi Inventario Activo</h4>
                <a href="{% url 'lista-productos-archivados' %}" class="btn btn-outline-secondary btn-sm">
                    <i class="bi bi-archive"></i> Ver Archivados
                </a>
            </div>
            <div class="card-body p-0" id="products-table">
                <div class="p-3">
                    <input type="text" class="form-control search" placeholder="Buscar producto...">
                </div>
                <div class="scrollable-table-container">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover mb-0">
                           <thead class="table-light">
                              <tr>
                                 <th>Nombre</th>
                                 <th>Precio</th>
                                 <th>Stock</th>
                                 <th>Unidad</th>
                                 <th>Precio Mayoreo</th> <th>Estado</th>
                                 <th>Acciones</th>
                              </tr>
                           </thead>
                           <tbody class="list">
                            {% for producto in productos %}
                            <tr class="{% if not producto.is_active %}table-secondary text-muted{% endif %}">
                                 <td class="name">{{ producto.nombre }}</td>
                                 <td>${{ producto.precio|floatformat:2 }}</td>
                                 <td>
                                    {% if producto.stock is not None %}
                                        {{ producto.stock }}
                                    {% else %}
                                        N/A
                                    {% endif %}
                                 </td>
                                 <td>{{ producto.get_unidad_medida_display }}</td>
                                 <td>
                                    {% if producto.precio_mayoreo %}
                                        ${{ producto.precio_mayoreo|floatformat:2 }} desde {{ producto.mayoreo_desde_kg }} {% if producto.unidad_medida == 'kg' %}Kg{% else %}u.{% endif %}
                                    {% else %}
                                        N/A
                                    {% endif %}
                                 </td>
                                 <td>
                                     {% if producto.is_active %}
                                         <span class="badge bg-success">Activo</span>
                                     {% else %}
                                         <span class="badge bg-danger">Inactivo</span>
                                     {% endif %}
                                 </td>
                                 <td class="d-flex gap-1">
                                     <a href="{% url 'editar-producto' producto.id %}" class="btn btn-warning btn-sm">Editar</a>
                                     
                                     {% if producto.is_active %}
                                         <form action="{% url 'eliminar-producto' producto.id %}" method="post" class="d-inline">
                                             {% csrf_token %}
                                             <button type="submit" class="btn btn-danger btn-sm">Desactivar</button>
                                         </form>
                                     {% else %}
                                         <form action="{% url 'reactivar-producto' producto.id %}" method="post" class="d-inline">
                                             {% csrf_token %}
                                             <button type="submit" class="btn btn-info btn-sm">Reactivar</button>
                                         </form>
                                     {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="7" class="text-center p-4">Aún no has agregado ningún producto activo.</td>
                            </tr>
                            {% endfor %}
                         </tbody>
                       </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Lógica para el interruptor de STOCK ---
    const requiereStockSwitch = document.getElementById('{{ form.requiere_stock.id_for_label }}');
    const stockFieldWrapper = document.getElementById('stock-field-wrapper');

    function toggleStockField() {
        if (requiereStockSwitch.checked) {
            stockFieldWrapper.style.display = 'block';
        } else {
            stockFieldWrapper.style.display = 'none';
        }
    }
    toggleStockField();
    requiereStockSwitch.addEventListener('change', toggleStockField);

    // --- Lógica para el interruptor de MAYOREO ---
    const mayoreoSwitch = document.getElementById('mayoreoSwitch');
    const mayoreoFieldsWrapper = document.getElementById('mayoreo-fields-wrapper');
    const precioMayoreoInput = document.getElementById('{{ form.precio_mayoreo.id_for_label }}');
    const desdeKgInput = document.getElementById('{{ form.mayoreo_desde_kg.id_for_label }}');

    function toggleMayoreoFields() {
        if (mayoreoSwitch.checked) {
            mayoreoFieldsWrapper.style.display = 'block';
        } else {
            mayoreoFieldsWrapper.style.display = 'none';
        }
    }
    
    // Comprobar si los campos de mayoreo ya tienen valor al cargar la página (para el modo de edición)
    if (precioMayoreoInput.value) {
        mayoreoSwitch.checked = true;
    }
    
    toggleMayoreoFields();
    mayoreoSwitch.addEventListener('change', toggleMayoreoFields);

    // --- Lógica para la búsqueda con List.js ---
    const productList = new List('products-table', {
        valueNames: ['name']
    });
});
</script>
{% endblock %}