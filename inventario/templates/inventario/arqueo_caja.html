{% extends "inventario/base.html" %}

{% block title %}Arqueo de Caja{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="mb-0">💰 Arqueo de Caja del Día ({{ fecha|date:"d/m/Y" }})</h1>
    <button id="btn-imprimir-arqueo" class="btn btn-secondary">Imprimir Arqueo</button>
</div>

<div class="card">
    <div class="card-body p-4">
        <div class="d-flex justify-content-between py-3 border-bottom">
            <span class="fs-5">(+) Ventas en Efectivo:</span>
            <span class="fs-5 fw-bold">${{ total_efectivo|floatformat:2 }}</span>
        </div>
        <div class="d-flex justify-content-between py-3 border-bottom">
            <span class="fs-5">(+) Ventas con Tarjeta:</span>
            <span class="fs-5 fw-bold">${{ total_tarjeta|floatformat:2 }}</span>
        </div>
        <div class="d-flex justify-content-between py-3 border-bottom fw-bold">
            <span class="fs-5">(=) Total de Ventas del Día:</span>
            <span class="fs-5">${{ total_ventas|floatformat:2 }}</span>
        </div>
        <div class="d-flex justify-content-between py-3 border-bottom mt-3">
            <span class="fs-5">(-) Total de Retiros del Día:</span>
            <span class="fs-5 fw-bold text-danger">-${{ total_retiros|floatformat:2 }}</span>
        </div>
        <div class="d-flex justify-content-between pt-3 mt-3 border-top border-2 border-dark">
            <span class="fs-4 fw-bold">(=) Efectivo Esperado en Caja:</span>
            <span class="fs-4 fw-bold text-success">${{ efectivo_esperado|floatformat:2 }}</span>
        </div>
    </div>
</div>

<script>
    document.getElementById('btn-imprimir-arqueo').addEventListener('click', function() {
        const textoTicket = JSON.parse('{{ texto_arqueo_json|escapejs }}');
        const urlPuente = "http://127.0.0.1:5000/print";
        const boton = this; // Guardamos una referencia al botón

        // Opcional: Deshabilitar el botón para evitar clics múltiples
        boton.disabled = true;
        boton.textContent = 'Imprimiendo...';
        
        fetch(urlPuente, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ticket_text: textoTicket })
        })
        .then(response => {
            if (!response.ok) {
                return Promise.reject('Error de red');
            }
            alert('Arqueo enviado a la impresora.');
        })
        .catch((error) => {
            alert('Error: No se pudo conectar con la impresora. Asegúrate de que el "puente_impresora.py" esté en ejecución.');
        })
        .finally(() => {
            // Volver a habilitar el botón
            boton.disabled = false;
            boton.textContent = 'Imprimir Arqueo';
        });
    });
</script>
{% endblock %}