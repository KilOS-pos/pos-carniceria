{% extends "inventario/base.html" %}

{% block title %}Arqueo de Caja{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="mb-0">游눯 Arqueo de Caja del D칤a ({{ fecha|date:"d/m/Y" }})</h1>
</div>

<div class="card">
    <div class="card-body p-4">
        <div class="d-flex justify-content-between py-3 border-bottom">
            <span class="fs-5">(+) Ventas en Efectivo:</span>
            <span class="fs-5 fw-bold">${{ total_efectivo|floatformat:2 }}</span>
        </div>
        <div class="d-flex justify-content-between py-3 border-bottom">
            <span class="fs-5">(+) Ventas con Tarjeta:</span>
            <span class="fs-5 fw-bold">${{ total_tarjeta|floatformat:2 }}</span>
        </div>
        <div class="d-flex justify-content-between py-3 border-bottom fw-bold">
            <span class="fs-5">(=) Total de Ventas del D칤a:</span>
            <span class="fs-5">${{ total_ventas|floatformat:2 }}</span>
        </div>
        <div class="d-flex justify-content-between py-3 border-bottom mt-3">
            <span class="fs-5">(-) Total de Retiros del D칤a:</span>
            <span class="fs-5 fw-bold text-danger">-${{ total_retiros|floatformat:2 }}</span>
        </div>
        <div class="d-flex justify-content-between pt-3 mt-3 border-top border-2 border-dark">
            <span class="fs-4 fw-bold">(=) Efectivo Esperado en Caja:</span>
            <span class="fs-4 fw-bold text-success">${{ efectivo_esperado|floatformat:2 }}</span>
        </div>
    </div>
</div>
<div class="card mt-4">
    <div class="card-body p-4">
        <h2 class="h3">Cierre de Caja</h2>
        <p class="text-muted">Ingresa el monto de efectivo que tienes en la caja para el cierre del d칤a. Esto reiniciar치 los totales para el pr칩ximo turno.</p>
        <form method="post" action="{% url 'cerrar-caja' %}">
            {% csrf_token %}
            <div class="mb-3">
                <label for="monto_contado" class="form-label">Monto de efectivo en la caja</label>
                <input type="number" step="0.01" name="monto_contado" id="monto_contado" class="form-control" required>
            </div>
            <button type="submit" class="btn btn-danger btn-lg">Cerrar Caja y Reiniciar</button>
        </form>
    </div>
</div>

<script>
    document.getElementById('btn-imprimir-arqueo').addEventListener('click', function() {
        const textoTicket = JSON.parse('{{ texto_arqueo_json|escapejs }}');
        const urlPuente = '{{ url_puente_impresora }}';
        
        const boton = this; // Guardamos una referencia al bot칩n

        // Opcional: Deshabilitar el bot칩n para evitar clics m칰ltiples
        boton.disabled = true;
        boton.textContent = 'Imprimiendo...';
        
        fetch(urlPuente, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ticket_text: textoTicket })
        })
        .then(response => {
            if (!response.ok) {
                return Promise.reject('Error de red');
            }
            alert('Arqueo enviado a la impresora.');
        })
        .catch((error) => {
            alert('Error: No se pudo conectar con la impresora. Aseg칰rate de que el "puente_impresora.py" est칠 en ejecuci칩n.');
        })
        .finally(() => {
            // Volver a habilitar el bot칩n
            boton.disabled = false;
            boton.textContent = 'Imprimir Arqueo';
        });
    });
</script>
{% endblock %}